#!/bin/bash

#
# pacaur: A simple cower and burp wrapper to fetch PKGBUILDS from aur & abs
#

name="pacaur"
version="1.1.0"
description="A simple cower wrapper to fetch PKGBUILDS from aur & abs"
author="Remy Marquis"
date="22/06/2011"

#
# Default config
#

pacmanBin="pacman"              # pacman binary
editor=$EDITOR                  # PKGBUILD editor
buildDir=/home/aur/build        # build directory
clean=true                      # cleanup after install
fallback=true                   # pacman fallback
color=true                      # enable color

colorR="\e[1;31m"
colorG="\e[1;32m"
colorY="\e[1;33m"
colorB="\e[1;34m"
colorM="\e[1;35m"
colorC="\e[1;36m"
colorW="\e[1;37m"

#
# Source user config
#

source /etc/pacaur.conf

#
# Color
#

if $color; then
    pacaur='cower --color=always'
    bold=$(tput bold)
    reset=$(tput sgr0)
else
    pacaur='cower'
    bold=''
    reset=''
    colorR=''
    colorG=''
    colorY=''
    colorB=''
    colorM=''
    colorC=''
    colorW=''
fi

#
# Working global variables
#

confSourced=false
installPkg=false
force=false
devel=false

#
# Functions
#

SearchAur() {
    $pacaur -s $@
}

InfoAur() {
    $pacaur -i $@
}

InfoDetailsAur() {
    $pacaur -ii $@
}

DownloadAur() {
    $pacaur -d $@ -t $buildDir
}

DownloadDepsAur() {
    # Download dependencies recursively and return AUR deps only
    deps=$($pacaur -dd $@ -t $buildDir | tee 1>&2 >(awk -F " " '{print $2}'| sed -r "s:\x1B\[[0-9;]*[mK]::g"))

    ErrorExit $deps
}

FindDepsAur() {
    # Find dependencies
    adeps=($($pacaur -ii $@ --format '%D%M' | awk -F "\n" '{print}' | awk -F " " '{print}' | sed -r "s:\x1B\[[0-9;]*[mK]::g"))

    ErrorExit $adeps

    # if no dependency, no need to continue
    if [[ ${#adeps[*]} -eq 0 ]]; then
        return
    fi

    local i=0
    for package in ${adeps[@]}; do
        # Remove versioning from package names
        adeps[$i]=${package%%=*}
        adeps[$i]=${adeps[$i]%%>*}
        adeps[$i]=${adeps[$i]%%<*}
        # Remove packages found in repo
        if [[ $(expac -S %n | grep -x ${adeps[$i]}) == ${adeps[$i]} ]]; then
            unset adeps[$i]
        fi
        ((i++))
    done

    adeps=$(echo ${adeps[@]} | awk -F "\n" '{print}' | awk -F " " '{print}')
    adeps=( $adeps );

    if [[ ${#adeps[*]} -gt 0 ]]; then
        # Save AUR dependencies then continue"
        deps=("$@" "${deps[@]}" "${adeps[@]}")
        FindDepsAur ${adeps[@]} 
    fi
}

CheckAur() {
    #notice "${colorW}Checking AUR for package updates...${reset}"
    $pacaur -u $@
}

CheckRepo() {
    #notice "${colorW}Checking repositories for package updates...${reset}"
    outofdate=($($pacmanBin -Quq $@))
    if [[ ${outofdate[@]} != "" ]]; then
        Qversion=($(expac -Q %v ${outofdate[@]}))
        Sversion=($(expac -S -1 %v ${outofdate[@]}))

        local i=0
        for package in ${outofdate[@]}; do
            notice "${colorW}${outofdate[$i]} ${colorR}${Qversion[$i]} ${reset}-> ${colorG}${Sversion[$i]}${reset}"
            ((i++))
        done
    fi
}

UpgradeAur() {
    notice "${colorW}Starting AUR upgrade...${reset}"
    CheckUpdatesAur=$($pacaur -u $@ | tee 1>&2 >(awk -F " " '{print $2}'| sed -r "s:\x1B\[[0-9;]*[mK]::g"))

    # add devel packages
    if $devel; then
        aurpkgs=( $($pacmanBin -Qmq) )
        Qversion=($(expac -Q %v ${aurpkgs[@]}))
        Qname=($(expac -Q %n ${aurpkgs[@]}))

        local i=0
        for package in ${aurpkgs[@]}; do
            if [[ ${Qversion[$i]} =~ [0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]-[0-9] ]]; then
                aurdevel=("${aurdevel[@]}" "${Qname[$i]}")
                notice "${colorW}${Qname[$i]} ${colorY}${Qversion[$i]} ${reset}"
            fi
            ((i++))
        done

        CheckUpdatesAur=("${CheckUpdatesAur[@]}" "${aurdevel[@]}")
        CheckUpdatesAur=$(echo ${CheckUpdatesAur[@]} | awk -F "\n" '{print}' | awk -F " " '{print}')
    fi

    if [[ $CheckUpdatesAur == "" ]]; then
        echo -e " there is nothing to do"
        exit   
    fi

    ErrorExit $CheckUpdatesAur

    echo -e ""
    notice "Proceed with installation? [Y/n]"
    
    while true; do
        read yn
        case $yn in
        [Yy]* | Yes | yes)
            u=${CheckUpdatesAur}
            upgrade=true
            break
        ;;
        [Nn]* | No | no)
            exit
            break
        ;;
        *)
            exit
            break
        ;;
        esac
    done
}

CopyAbs() {
    for i in "$@"
    do
        if [[ -e $buildDir/$i/PKGBUILD && $force != true ]]; then
            failed "${colorW}$i${reset} PKGBUILD already exists in $buildDir. Use -f to overwrite."
        else
            cp -r `find /var/abs -name "$i"` $buildDir || error "${colorW}$i${reset} not found"
            success "${colorW}$i${reset} copied in $buildDir"
        fi
    done
}

EditPkgs() {
    for i in "$@"
    do
        if [ -e $buildDir/$i/PKGBUILD ]; then
            $editor $buildDir/$i/PKGBUILD
            success "${colorW}$i${reset} PKGBUILD edited"
        else
            error "Could not open ${colorW}$i${reset} PKGBUILD"
        fi
    done
}

CleanUp() {
    if $clean; then
        cd $buildDir
        for i in $@
        do
            notice "Cleaning up ${colorW}$i${reset}... "
            rm -r $i && success "${colorW}$i${reset} cleaned" || failed "Could not clean ${colorW}$i${reset}"
        done
    fi
}

MakePkgs() {
    # Reverse deps order
    deps=($(echo ${deps[@]} | awk -F "\n" '{print}' | awk -F " " '{for (i=NF;i>=1;i--) print $i}'))
    notice "AUR package(s) to build: ${colorW}${deps[@]}${reset}"

    # Remember explicitly installed packages
    if [[ $expl == "" ]]; then
      read -ra expl <<< ${@}
    fi

    # Set architecture variables
    if ! $confSourced; then
        source /etc/makepkg.conf
        source /etc/abs.conf
        confSourced=true
    fi

    local j
    for j in "${deps[@]}"
    do
        if [ -e $buildDir/$j/PKGBUILD ]; then
            notice "Building ${colorW}$j${reset} package..."
            cd $buildDir/$j
            if $installPkg; then
                if $force; then
                    makepkg -sfi
                else
                    makepkg -si
                fi
                # If AUR dep, install as --asdeps
                # If upgrade, do no change status
                if [[ ! $upgrade ]]; then
                    isexpl=false
                    for k in ${expl[@]}; do
                        if [[ $k == $j ]]; then
                            isexpl=true
                        fi
                    done
                    if [[ $isexpl != true ]]; then
                        sudo $pacmanBin -D --asdeps $j &>/dev/null
                    fi
                fi
            elif $force; then
                #makepkg -sf
                makepkg -df
            else
                #makepkg -s
                makepkg -d
            fi
        else
            error "Could not open ${colorW}$j${reset} PKGBUILD"
        fi
    done
}

ErrorExit(){
    # Exit if curl or package name error
    if [[ $(echo $@ | grep -v "Couldn't resolve host name" | grep -v "no results found for") == "" ]]; then 
        exit
    fi
}

error() {
    echo -e "${colorR}::${reset} $1"
    exit
}

success() {
    echo -e "${colorG}::${reset} $1"
}

failed() {
    echo -e "${colorY}::${reset} $1"
}

notice() {
    echo -e "${colorB}::${reset} $1"
}

usage() {
    echo -e "usage:  ${name} <operation> [options] [package(s)]"
    echo -e "operations:"
    echo -e "   -s, --search    search AUR repository for matching strings"
    echo -e "   -i, --info      view package information -- pass twice for details"
    echo -e "   -d, --download  download target(s) -- pass twice to download AUR dependencies"
    echo -e "   -b, --build     use existing PKGBUILD and make target(s)"
    echo -e "   -m, --makepkg   download and make target(s)"
    echo -e "   -y, --sync      download, make and install target(s)"
    echo -e "   -q, --check     check for AUR update(s)"
    echo -e "   -u, --update    update AUR package(s)"
    echo -e "   -abs, --abs     copy target(s) from ABS directory to build directory"
    echo -e "   -c, --clean     clean existing target(s) PKGBUILD"
    echo -e ""
    echo -e "options:"
    echo -e "   -f, --force     force operation -- can be combined with the -d, -b, -m flags"
    echo -e "   -e, --edit      edit target PKGBUILD -- can be combined with the -d, -b, -m, -y, -u, -abs flags"
    echo -e ""
    echo -e "pacman options:"
    echo -e " can be used with the -S, -Ss, -Si, -Sii, -Sw, -Su, -Qu, -Syu operations"
    echo -e "   -r, --repo      only search or install packages from the repositories"
    echo -e "   -a, --aur       only search or install packages from the AUR"
    echo -e "   --devel         update devel packages -- can be combined with the -Su flag"
    echo -e ""
    echo -e "general options:"
    echo -e "   -v, --version   display version information"
    echo -e "   -h, --help      display help information"
    echo -e ""
}

version() {
    echo -e "\n    ${colorW}$name ${colorG}$version${reset}"
    echo -e "    $description"
    echo -e "    -${colorW}$author ${colorG}($date)\n"
}


#
# Main
#

main() {
    case $1 in
    # search
    -s | --search)
        shift
        SearchAur $@
    ;;
    # info
    -i | --info)
        case $2 in
        -i | --info)
            shift 2
            InfoDetailsAur $@
        ;;
        *)
            shift
            InfoAur $@
        ;;
        esac
    ;;
    # download
    -d | --download)
        case $2 in
        -d | --download)
            case $3 in
            -f | --force)
                case $4 in
                -e | --edit)
                    shift 4
                    DownloadDepsAur $@ -f
                    EditPkgs $deps
                ;;
                *)
                    shift 3
                    DownloadDepsAur $@ -f
                ;;
                esac
            ;;
            -e | --edit)
                shift 3
                DownloadDepsAur $@
                EditPkgs $deps
            ;;
            *)
                shift 2
                DownloadDepsAur $@
            ;;
            esac
        ;;
        -f | --force)
            case $3 in
            -e | --edit)
                shift 3
                DownloadAur $@ -f
                EditPkgs $@
            ;;
            *)
                shift 2
                DownloadAur $@ -f
            ;;
            esac
        ;;
        -e | --edit)
            shift 2
            DownloadAur $@
            EditPkgs $@
        ;;
        *)  shift
            DownloadAur $@
        ;;
        esac
    ;;
    # build
    -b | --build)
        case $2 in
        -f | --force)
            force=true
            case $3 in
            -e | --edit)
                shift 3
                FindDepsAur $@
                EditPkgs ${deps[@]}
                MakePkgs ${deps[@]}
            ;;
            *)
                shift 2
                FindDepsAur $@
                MakePkgs ${deps[@]}
            ;;
            esac
        ;;
        -e | --edit)
            case $3 in
            -f | --force)
                force=true
                shift 3
                FindDepsAur $@
                EditPkgs ${deps[@]}
                MakePkgs ${deps[@]}
            ;;
            *)
                shift 2
                FindDepsAur $@
                EditPkgs ${deps[@]}
                MakePkgs ${deps[@]}
            ;;
            esac
        ;;
        *)
            shift
            FindDepsAur $@
            MakePkgs ${deps[@]}
        ;;
        esac
    ;;
    # makepkg
    -m | --makepkg)
        case $2 in
        -f | --force)
            force=true
            case $3 in
            -e | --edit)
                shift 3
                DownloadDepsAur $@ -f
                EditPkgs $deps
                MakePkgs $@
                CleanUp ${deps[@]}
            ;;
            *)
                shift 2
                DownloadDepsAur $@ -f
                MakePkgs $@
                CleanUp ${deps[@]}
            ;;
            esac
        ;;
        -e | --edit)
            case $3 in
            -f | --force)
                force=true
                shift 3
                DownloadDepsAur $@ -f
                EditPkgs $deps
                MakePkgs $@
                CleanUp ${deps[@]}
            ;;
            *)
                shift 2
                DownloadDepsAur $@ -f
                EditPkgs $deps
                MakePkgs $@
                CleanUp ${deps[@]}
            ;;
            esac
        ;;
        *)
            shift
            DownloadDepsAur $@ -f
            MakePkgs $@
            CleanUp ${deps[@]}
        ;;
        esac
    ;;
    # install
    -y | --sync)
    case $2 in
        -e | --edit)
            shift 2
            DownloadDepsAur $@ -f
            EditPkgs $deps
            force=true
            installPkg=true
            MakePkgs $@
            CleanUp ${deps[@]}
        ;;
        *)
            shift
            DownloadDepsAur $@ -f
            force=true
            installPkg=true
            MakePkgs $@
            CleanUp ${deps[@]}
        ;;
        esac
    ;;
    # check update
    -q | --check)
        shift
        CheckAur $@
    ;;
    # update
    -u | --update)
        case $2 in
        -e | --edit)
            case $3 in
            --devel)
                shift 3
                devel=true
                UpgradeAur
                DownloadDepsAur $u -f
                EditPkgs $u
                force=true
                installPkg=true
                MakePkgs $u 
                CleanUp $u
            ;;
            *)
                shift 2
                UpgradeAur
                DownloadDepsAur $u -f
                EditPkgs $u
                force=true
                installPkg=true
                MakePkgs $u 
                CleanUp $u
            ;;
            esac
        ;;
        --devel)
            case $3 in
            -e | --edit)
                shift 3
                devel=true
                UpgradeAur
                DownloadDepsAur $u -f
                EditPkgs $u
                force=true
                installPkg=true
                MakePkgs $u 
                CleanUp $u
            ;;
            *)
                shift 2
                devel=true
                UpgradeAur
                DownloadDepsAur $u -f
                force=true
                installPkg=true
                MakePkgs $u 
                CleanUp $u
            ;;
            esac
        ;;
        *)
            shift
            UpgradeAur
            DownloadDepsAur $u -f
            force=true
            installPkg=true
            MakePkgs $u 
            CleanUp $u
        ;;
        esac
    ;;
    # edit
    -e | --edit)
        shift
        EditPkgs $@
    ;;
    # clean
    -c | --clean)
        shift
        clean=true
        CleanUp $@
    ;;
    # abs
    -abs | --abs)
        case $2 in
        -e | --edit)
            case $3 in
            -f | --force)
                shift 3 
                force=true
                CopyAbs $@
                EditPkgs $@
            ;;
            *)
                shift 2
                CopyAbs $@
                EditPkgs $@
            ;;
            esac
        ;;
        -f | --force)
            case $3 in
            -e | --edit)
                shift 3 
                force=true
                CopyAbs $@
                EditPkgs $@
            ;;
            *)
                shift 2
                force=true
                CopyAbs $@
            ;;
            esac
        ;;
        *)  shift
            CopyAbs $@
        ;;
        esac
    ;;
    # version
    -v | --version)
        shift
        version
    ;;
    # shortcuts
    -ii)
        shift
        pacaur -i -i $@
    ;;
    -abse)
        shift
        pacaur -abs -e $@
    ;;
    -absf)
        shift
        pacaur -abs -f $@
    ;;
    -absfe | -absef)
        shift
        pacaur -a -f -e $@
    ;;
    -df)
        shift
        pacaur -d -f $@
    ;;
    -de)
        shift
        pacaur -d -e $@
    ;;
    -dfe)
        shift
        pacaur -d -f -e $@
    ;;
    -dd)
        shift
        pacaur -d -d $@
    ;;
    -ddf)
        shift
        pacaur -d -d -f $@
    ;;
    -dde)
        shift
        pacaur -d -d -e $@
    ;;
    -ddfe | -ddef)
        shift
        pacaur -d -d -f -e $@
    ;;
    -be)
        shift
        pacaur -b -e $@
    ;;
    -bf)
        shift
        pacaur -b -f $@
    ;;
    -bef | -bfe)
        shift
        pacaur -b -e -f $@
    ;;
    -me)
        shift
        pacaur -m -e $@
    ;;
    -mf)
        shift
        pacaur -m -f $@
    ;;
    -mef | -mfe)
        shift
        pacaur -m -e -f $@
    ;;
    -ue)
        shift
        pacaur -u -e $@
    ;;
    -ye)
        shift
        pacaur -y -e $@
    ;;
    # pacman extension
    -S | --sync)
        case $2 in
        -s | --search)
            case $3 in
            -a | --aur)
                shift 3
                pacaur -s $@
            ;;
            -r | --repo)
                shift 3
                $pacmanBin -Ss $@
            ;;
            *)
                shift 2
                $pacmanBin -Ss $@
                if $fallback; then
                    pacaur -s $@
                fi
            ;;
            esac
        ;;
        -i | --info)
            case $3 in
            -a | --aur)
                shift 3
                pacaur -i $@
            ;;
            -r | --repo)
                shift 3
                $pacmanBin -Si $@
            ;;
            -i | --info)
                case $4 in
                -a | --aur)
                    shift 4
                    pacaur -i -i $@
                ;;
                -r | --repo)
                    shift 4
                    $pacmanBin -Sii $@
                ;;
                *)
                    shift 3
                    if $fallback; then
                        result=$($pacmanBin -Sii $@ 2>&1)
                        if [[ $(echo $result | grep -v "error: package") == "" ]]; then
                            failed "Package(s) ${colorW}$@${reset} not found in repositories, trying ${colorM}aur${reset}..."
                            pacaur -S -i -i -a $@
                        else
                            $pacmanBin -Sii $@
                        fi
                    else
                        $pacmanBin -Sii $@
                    fi
                ;;
                esac
            ;;
            *)
                shift 2
                if $fallback; then
                    result=$($pacmanBin -Si $@ 2>&1)
                    if [[ $(echo $result | grep -v "error: package") == "" ]]; then
                        failed "Package(s) ${colorW}$@${reset} not found in repositories, trying ${colorM}aur${reset}..."
                        pacaur -S -i -a $@
                    else
                        $pacmanBin -Si $@
                    fi
                else
                    $pacmanBin -Si $@
                fi
            ;;
            esac
        ;;
        -w | --downloadonly)
            case $3 in
            -a | --aur)
                shift 3
                pacaur -m -e -f $@
            ;;
            -r | --repo)
                shift 3
                sudo $pacmanBin -Sw $@
            ;;
            *)
                shift 2
                if $fallback; then
                    result=$($pacmanBin -Sw --print $@ 2>&1)
                    if [[ $(echo $result | grep -v "error: target not found") == "" ]]; then
                        failed "Package(s) ${colorW}$@${reset} not found in repositories, trying ${colorM}aur${reset}..."
                        pacaur -S -w -a $@
                    else
                        sudo $pacmanBin -Sw $@
                    fi
                else
                    sudo $pacmanBin -Sw $@
                fi
            ;;
            esac
        ;;
        -u | --upgrades)
            case $3 in
            -a | --aur)
                case $4 in
                --devel)
                    shift 4
                    pacaur -u -e --devel $@
                ;;
                *)
                    shift 3
                    pacaur -u -e $@
                ;;
                esac
            ;;
            -r | --repo)
                shift 3
                sudo $pacmanBin -Su $@
            ;;
            --devel)
                if $fallback; then
                    shift 5
                    sudo $pacmanBin -Su $@
                    pacaur -S -u -a --devel $@
                else
                    echo "$pacmanBin: unrecognized option '--devel'"
                fi
            ;;
            *)
                shift 2
                if $fallback; then
                    result=$($pacmanBin -Su --print $@ 2>&1)
                    if [[ ! $@ ]]; then
                        sudo $pacmanBin -Su
                        pacaur -S -u -a
                    elif [[ $(echo $result | grep -v "error: target not found") == "" ]]; then
                        failed "Package(s) ${colorW}$@${reset} not found in repositories, trying ${colorM}aur${reset}..."
                        pacaur -S -u -a $@
                    else
                        sudo $pacmanBin -Su $@
                    fi
                else
                    sudo $pacmanBin -Su $@
                fi
            ;;
            esac
        ;;
        -y | --refresh)
            case $3 in
            -a | --aur)
                shift 3
                sudo $pacmanBin -Sy
                pacaur -y -e $@
            ;;
            -r | --repo)
                shift 3
                sudo $pacmanBin -Sy $@
            ;;
            -u | --sysupgrade)
                case $4 in
                -a | --aur)
                    shift 4
                    sudo $pacmanBin -Syu # fallback here
                    pacaur -u -e $@
                ;;
                -r | --repo)
                    shift 4
                    sudo $pacmanBin -Syu
                ;;
                *)
                    shift 3
                    sudo $pacmanBin -Syu $@
                    if $fallback; then
                        pacaur -S -u -a $@
                    fi
                ;;
                esac
            ;;
            *)
                shift 2
                sudo $pacmanBin -Sy $@ # no fallback here
            esac
        ;;
        -a | --aur)
            shift 2
            pacaur -y -e $@
        ;;
        -r | --repo)
            shift 2
            sudo $pacmanBin -S $@
        ;;
        *)
            shift
            if $fallback; then
                result=$($pacmanBin -S --print $@ 2>&1)
                if [[ $(echo $result | grep -v "error: target not found") == "" ]]; then
                    failed "Package(s) ${colorW}$@${reset} not found in repositories, trying ${colorM}aur${reset}..."
                    pacaur -S -a $@
                else
                    sudo $pacmanBin -S $@
                fi
            else
                sudo $pacmanBin -S $@
            fi
        esac
    ;;
    -Ss)
        case $2 in
        -a | --aur)
            shift 2
            pacaur -S -s -a $@
        ;;
        -r | --repo)
            shift 2
            pacaur -S -s -r $@
        ;;
        *)
            shift
            pacaur -S -s $@
        ;;
        esac
    ;;
    -Si)
        case $2 in
        -a | --aur)
            shift 2
            pacaur -S -i -a $@
        ;;
        -r | --repo)
            shift 2
            pacaur -S -i -r $@
        ;;
        -i | --info)
            case $3 in
            -a | --aur)
                shift 3
                pacaur -S -i -i -a $@
            ;;
            -r | --repo)
                shift 3
                pacaur -S -i -i -r $@
            ;;
            *)
                shift 2
                pacaur -S -i -i $@
            ;;
            esac
        ;;
        *)
            shift
            pacaur -S -i $@
        ;;
        esac
    ;;
    -Sii)
        case $2 in
        -a | --aur)
            shift 2
            pacaur -S -i -i -a $@
        ;;
        -r | --repo)
            shift 2
            pacaur -S -i -i -r $@
        ;;
        *)
            shift
            pacaur -S -i -i $@
        ;;
        esac
    ;;
    -Sw)
        case $2 in
        -a | --aur)
            shift 2
            pacaur -S -w -a $@
        ;;
        -r | --repo)
            shift 2
            pacaur -S -w -r $@
        ;;
        *)
            shift
            pacaur -S -w $@
        ;;
        esac
    ;;
    -Su)
        case $2 in
        -a | --aur)
            case $3 in
            --devel)
                shift 3
                pacaur -S -u -a --devel $@
            ;;
            *)
                shift 2
                pacaur -S -u -a $@
            ;;
            esac
        ;;
        -r | --repo)
            shift 2
            pacaur -S -u -r $@
        ;;
        --devel)
            if $fallback;then
                pacaur -S -u --devel $@
            else
                echo "$pacmanBin: unrecognized option '--devel'"
            fi
        ;;
        *)
            shift
            pacaur -S -u $@
        ;;
        esac
    ;;
    -Sy)
        case $2 in
        -a | --aur)
            shift 2
            pacaur -S -y -a $@
        ;;
        -r | --repo)
            shift 2
            pacaur -S -y -r $@
        ;;
        -u | --sysupgrade)
            case $3 in
            -a | --aur)
                shift 3
                pacaur -S -y -u -a $@
            ;;
            -r | --repo)
                shift 3
                pacaur -S -y -u -r $@
            ;;
            *)
                shift 2
                pacaur -S -y -u $@
            ;;
            esac
        ;;
        *)
            shift
            pacaur -S -y $@
        esac
    ;;
    -Syu)
        case $2 in
        -a | --aur)
            shift 2
            pacaur -S -y -u -a $@
        ;;
        -r | --repo)
            shift 2
            pacaur -S -y -u -r $@
        ;;
        *)
            shift
            pacaur -S -y -u $@
        ;;
        esac
    ;;
    -S)
        case $2 in
        -a | --aur)
            shift 2
            pacaur -S -a $@
        ;;
        -r | --repo)
            shift 2
            pacaur -S -r $@
        ;;
        *)
            shift
            pacaur -S $@
        ;;
        esac
    ;;
    -Ssa)
        shift
        pacaur -S -s -a $@
    ;;
    -Sia)
        shift
        pacaur -S -i -a $@
    ;;
    -Siia)
        shift
        pacaur -S -i -i -a $@
    ;;
    -Swa)
        shift
        pacaur -S -w -a $@
    ;;
    -Sua)
        case $2 in
        --devel)
            shift 2
            pacaur -S -u -a --devel $@
        ;;
        *)
            shift
            pacaur -S -u -a $@
        ;;
        esac
    ;;
    -Sya)
        shift
        pacaur -S -y -a $@
    ;;
    -Syua)
        shift
        pacaur -S -y -u -a $@
    ;;
    -Sa)
        shift
        pacaur -S -a $@
    ;;
    -Ssr)
        shift
        pacaur -S -s -r $@
    ;;
    -Sir)
        shift
        pacaur -S -i -r $@
    ;;
    -Siir)
        shift
        pacaur -S -i -i -r $@
    ;;
    -Swr)
        shift
        pacaur -S -w -r $@
    ;;
    -Sur)
        shift
        pacaur -S -u -r $@
    ;;
    -Syr)
        shift
        pacaur -S -y -r $@
    ;;
    -Syur)
        shift
        pacaur -S -y -u -r $@
    ;;
    -Sr)
        shift
        pacaur -S -r $@
    ;;
    -Q)
        case $2 in
        -u | --upgrades)
            case $3 in
            -a | --aur)
                shift 3
                CheckAur $@
            ;;
            -r | --repo)
                shift 3
                CheckRepo $@
            ;;
            *)
                shift 2
                CheckRepo $@
                if $fallback;then
                    CheckAur $@
                fi
            ;;
            esac
        ;;
        *)
            shift
            $pacmanBin -Q $@
        esac
    ;;
    -Qu)
        case $2 in
        -a | --aur)
            shift 2
            pacaur -Q -u -a $@
        ;;
        -r | --repo)
            shift 2
            pacaur -Q -u -r $@
        ;;
        *)
            shift
            pacaur -Q -u $@
        ;;
        esac
    ;;
    -Qua)
        shift
        pacaur -Q -u -a $@
    ;;
    -Qur)
        shift
        pacaur -Q -u -r $@
    ;;
    -D* | --database)
        sudo $pacmanBin $@
    ;;
    -Q* | --query)
        $pacmanBin $@
    ;;
    -R* | --remove)
        sudo $pacmanBin $@
    ;;
    -S* | --sync)
        sudo $pacmanBin $@
    ;;
    -T* | --deptest)
        sudo $pacmanBin $@
    ;;
    -U* | --upgrade)
        sudo $pacmanBin $@
    ;;
    -V | --Version)
        $pacmanBin $@
    ;;
    -h | --help)
        usage
        $pacmanBin $@
    ;;
    --*)
        sudo $pacmanBin $@
    ;;
    *)
        usage
    ;;
    esac
}

if [[ ! -d $buildDir ]]; then
  error "Build directory does not exist!\nCheck configuration in /etc/${name}.conf"
fi

main "$@"

# vim:set ts=2 sw=2 et:
